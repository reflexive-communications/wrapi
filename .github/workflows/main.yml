name: CI

on:
    pull_request:
        branches: [ main ]

jobs:
  tests:
    name: Unit tests
    runs-on: ubuntu-18.04
    env:
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: drupal
      APACHE_DIR: "/etc/apache2"
      SITE_NAME: "composer-site.com"
      LOCAL_DEPLOY_TARGET: "/var/www/html"
      EXTENSION_NAME: "wrapi"
    services:
      mysql:
        image: mysql:5.7
        env:
          MYSQL_ROOT_PASSWORD: ${{ env.MYSQL_ROOT_PASSWORD }}
          MYSQL_ALLOW_EMPTY_PASSWORD: yes
          MYSQL_DATABASE: ${{ env.MYSQL_DATABASE }}
        ports:
         - 3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
    steps:
    - name: Setup PHP and the extensions also the tools
      uses: shivammathur/setup-php@v2
      with:
        php-version: '7.3'
        tools: composer:v1, phpunit:8.5.0
        extensions: cli fpm mysql json opcache mbstring xml gd curl intl

    - name: Start mysql daemon.
      run: |
          sudo systemctl start mysql

    - name: Install CV command
      run: |
          curl -LsS https://download.civicrm.org/cv/cv.phar -o cv
          sudo mv cv /usr/local/bin/
          sudo chmod +x /usr/local/bin/cv

    - name: Create /home/runner/.cv.json file
      run: |
          echo "{\"sites\":{\"${{ env.LOCAL_DEPLOY_TARGET }}/${{ env.SITE_NAME }}/web/sites/default/civicrm.settings.php\":{\"TEST_DB_DSN\":\"mysql://root:${{ env.MYSQL_ROOT_PASSWORD }}@127.0.0.1:${{ job.services.mysql.ports['3306'] }}/${{ env.MYSQL_DATABASE }}?new_link=true\"}}}" > /home/runner/.cv.json
          cat /home/runner/.cv.json

    - name: Basic apache module and config
      run: |
          sudo apt-get update
          sudo apt-get install libapache2-mod-php7.3
          sudo a2enmod rewrite

    - name: Get DSG application.
      uses: actions/checkout@v2
      with:
          repository: akosgarai/dsg
          path: dsg
          ref: update-model

    - name: Build drupal site with civicrm.
      env:
        PROJECT_BASE_PATH: "."
        SITE_NAME: ${{ env.SITE_NAME }}
        DB_NAME: ${{ env.MYSQL_DATABASE }}
        DB_HOST: "127.0.0.1"
        DB_PORT: ${{ job.services.mysql.ports['3306'] }}
        DB_USER: "root@localhost"
        MYSQL_DB_PASS: ${{ env.MYSQL_ROOT_PASSWORD }}
        SITE_ADMIN_NAME: "admin"
        SITE_ADMIN_PW: "jPoLvGGGV5"
        APACHE_CONF_DIR: ${{ env.APACHE_DIR }}
        LOCAL_DEPLOY_TARGET: ${{ env.LOCAL_DEPLOY_TARGET }}
        COMPOSER_APP: composer
      run: |
          sudo mv dsg/apache2.conf ${{ env.APACHE_DIR }}/apache2.conf
          ./dsg/scripts.sh ci-build --project-base-path "${PROJECT_BASE_PATH}" --project-name "${SITE_NAME}" --db-name "${DB_NAME}" --db-user-name "${DB_USER}" --site-admin-user-name "${SITE_ADMIN_NAME}" --site-admin-password "${SITE_ADMIN_PW}" --apache-conf-dir "${APACHE_CONF_DIR}" --db-host "${DB_HOST}" --db-port "${DB_PORT}" --root-db-user-pw "${MYSQL_DB_PASS}" --local-deploy-target "${LOCAL_DEPLOY_TARGET}" -s --composer-app "${COMPOSER_APP}"
          sudo mkdir "${LOCAL_DEPLOY_TARGET}/${SITE_NAME}/extensions"
          sudo chown "www-data:" "${LOCAL_DEPLOY_TARGET}/${SITE_NAME}/extensions"
          cd ${LOCAL_DEPLOY_TARGET}/${SITE_NAME}
          cv vars:fill
          cat /home/runner*.cv.json

    - name: Check out the code
      uses: actions/checkout@v2
      with:
          path: ${{ env.EXTENSION_NAME }}

    - name: Move ${{ env.EXTENSION_NAME }} under extensions directory
      run: |
          sudo mv ${{ env.EXTENSION_NAME }} ${{ env.LOCAL_DEPLOY_TARGET }}"/"${{ env.SITE_NAME }}"/extensions"

    - name: Change extensions directory.
      run: |
          cd ${{ env.LOCAL_DEPLOY_TARGET }}"/"${{ env.SITE_NAME }}
          cv api Setting.create extensionsDir="[cms.root]/extensions/"
          cv api Setting.create extensionsURL="[cms.root]/extensions/"

    - name: Run unit tests
      run: |
          cd ${{ env.LOCAL_DEPLOY_TARGET }}"/"${{ env.SITE_NAME }}"/extensions/"${{ env.EXTENSION_NAME }}
          phpunit
